#########################################################
## 'Get Workflow Input' Composite Action               ##
#########################################################
##
## This composite action contains the logic to read workflow runtime parameters and publih their value as a workflow output.
## This is essential in case a workflow was not triggered via 'workflow_dispatch' as this renders the otherwise available runtime parameters unavailable.
## To solve this, the action reads the workflow file and looks out for the default value to publish it as an output regardless.
##
## Currently publsihes the runtime parameter(s):
## - removeDeployment
##
#########################################################
##
##-------------------------------------------##
## ACTION PARAMETERS                         ##
##-------------------------------------------##
##
##   |===================================================================================================================================================================|
##   | Parameter    | Required | Default | Description                                                                      | Example                                    |
##   |--------------|----------|---------|----------------------------------------------------------------------------------|--------------------------------------------|
##   | workflowPath | true     | ''      | The path to the workflow file used to retrieve default workflow input parameters | '.github/workflows/ms.keyvault.vaults.yml' |
##   |===================================================================================================================================================================|
##
##---------------------------------------------##

name: 'Get Workflow Input'
description: 'Get Workflow Input'

inputs:
  workflowPath:
    description: 'The path to the workflow file used to retrieve default workflow input parameters.'
    required: true

outputs:
  removeDeployment:
    description: 'Remove deployed module'
    value: ${{ steps.get-input-param-action.outputs.removeDeployment }}

runs:
  using: 'composite'
  steps:
    - name: Get workflow input parameters
      id: get-input-param-action
      run: |
        # Grouping task logs
        Write-Output "::group::Get workflow input parameters"

        Write-Verbose "The workflow trigger is: ${{ github.event_name }}" -Verbose

        # When running from workflow_dispatch event get input values
        if ('${{ github.event_name }}' -eq 'workflow_dispatch') {
          $removeDeployment='${{ github.event.inputs.removeDeployment }}'
        }
        # Otherwise retrieve default values
        else {
          # Load used functions
          . "$env:GITHUB_ACTION_PATH/scripts/Get-WorkflowDefaultInput.ps1"

          $functionInput = @{
            workflowPath = '${{ inputs.workflowPath }}'
          }

          Write-Verbose "Invoke task with" -Verbose
          Write-Verbose ($functionInput | ConvertTo-Json | Out-String) -Verbose

          $workflowParameters = Get-WorkflowDefaultInput @functionInput -Verbose
          $removeDeployment = $workflowParameters.removeDeployment
        }

        # Output values to be accessed by next jobs
        Write-Output "::set-output name=removeDeployment::$removeDeployment"

        Write-Output "::endgroup::"
      shell: pwsh
