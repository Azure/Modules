name: "AA test workflow with actions"

on:
  workflow_dispatch:
    inputs:
      removeDeployment:
        description: 'Remove deployed module'
        required: false
        default: 'true'
      versioningOption:
        description: 'The mode to handle the version increments [major|minor|patch|custom]'
        required: false
        default: 'patch'
      customVersion:
        description: 'The version to enforce if [versionOption] is set to [custom]'
        required: false
        default: '0.0.1'
  push:
    branches:
      - main
    # paths:
    #   - '.github/actions/templates/**'
    #   - '.github/workflows/ms.analysisservices.servers.yml'
    #   - 'arm/Microsoft.AnalysisServices/servers/**'
    #   - '!arm/Microsoft.AnalysisServices/servers/readme.md'

env:
  moduleName: 'servers'
  modulePath: 'arm/Microsoft.AnalysisServices/servers'
  workflowPath: '.github/workflows/atestworkflowwithactions.yml'
  AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
  ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
  ARM_MGMTGROUP_ID: ${{ secrets.ARM_MGMTGROUP_ID }}

jobs:
  
  job_set_workflow_param:
    runs-on: ubuntu-20.04
    name: "Set input parameters to output variables"
    steps:
      - name: "Checkout"
        uses: actions/checkout@v2
        with:
          fetch-depth: 0
      - name: "Set input parameters"
        id: get-workflow-param
        uses: ./.github/actions/templates/getWorkflowInput
        with:
          workflowPath: '${{ env.workflowPath}}'
    outputs:
      removeDeployment: ${{ steps.get-workflow-param.outputs.removeDeployment }}
      versioningOption: ${{ steps.get-workflow-param.outputs.versioningOption }}
      customVersion: ${{ steps.get-workflow-param.outputs.customVersion }}
  
  job_get_workflow_param_removal:
    if: needs.job_set_workflow_param.outputs.removeDeployment == 'true'
    runs-on: ubuntu-20.04
    needs: job_set_workflow_param
    name: "Get job output variables if removal true"
    steps:
      - name: Access values from another job
        run: |
          echo "The removeDeployment is ${{ needs.job_set_workflow_param.outputs.removeDeployment}}"
          echo "The versioningOption is ${{ needs.job_set_workflow_param.outputs.versioningOption}}"
          echo "The customVersion is ${{ needs.job_set_workflow_param.outputs.customVersion}}"
      - name: Dump set workflow param
        env:
          jobContext: ${{ toJson(needs.job_set_workflow_param) }}
        run: echo "$jobContext"

  job_get_workflow_param_noremoval:
    if: needs.job_set_workflow_param.outputs.removeDeployment == 'false'
    runs-on: ubuntu-20.04
    needs: job_set_workflow_param
    name: "Get job output variables if removal false"
    steps:
      - name: Access values from another job
        run: |
          echo "The removeDeployment is ${{ needs.job_set_workflow_param.outputs.removeDeployment}}"
          echo "The versioningOption is ${{ needs.job_set_workflow_param.outputs.versioningOption}}"
          echo "The customVersion is ${{ needs.job_set_workflow_param.outputs.customVersion}}"
      - name: Dump set workflow param
        env:
          jobContext: ${{ toJson(needs.job_set_workflow_param) }}
        run: echo "$jobContext"
