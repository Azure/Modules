{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "alternativeParameterValues": {
            "type": "object",
            "defaultValue": {},
            "metadata": {
                "description": "Optional. Alternative parameter values."
            }
        },
        "connectionApi": {
            "type": "object",
            "defaultValue": {},
            "metadata": {
                "description": "Optional. Specific values for some API connections."
            }
        },
        "connectionKind": {
            "type": "string",
            "metadata": {
                "description": "Required. Connection Kind. Example: 'V1' when using blobs. It can change depending on the resource."
            }
        },
        "connectionName": {
            "type": "string",
            "metadata": {
                "description": "Required. Connection name for connection. Example: 'azureblob' when using blobs.  It can change depending on the resource."
            }
        },
        "cuaId": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Optional. Customer Usage Attribution id (GUID). This GUID must be previously registered."
            }
        },
        "customParameterValues": {
            "type": "object",
            "defaultValue": {},
            "metadata": {
                "description": "Optional. Customized parameter values for specific connections."
            }
        },
        "displayName": {
            "type": "string",
            "metadata": {
                "description": "Required. Display name connection. Example: 'blobconnection' when using blobs. It can change depending on the resource."
            }
        },
        "location": {
            "type": "string",
            "defaultValue": "[resourceGroup().location]",
            "metadata": {
                "description": "Optional. Location of the deployment."
            }
        },
        "nonSecretParameterValues": {
            "type": "object",
            "defaultValue": {},
            "metadata": {
                "description": "Optional. Dictionary of nonsecret parameter values."
            }
        },
        "parameterValues": {
            "type": "secureobject",
            "defaultValue": {},
            "metadata": {
                "description": "Optional. Connection strings or access keys for connection. Example: 'accountName' and 'accessKey' when using blobs.  It can change depending on the resource."
            }
        },
        "parameterValueType": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "Optional. Value Type of parameter, in case alternativeParameterValues is used."
            }
        },
        "roleAssignments": {
            "defaultValue": [],
            "type": "array",
            "metadata": {
                "description": "Optional. Array of role assignment objects that contain the 'roleDefinitionIdOrName' and 'principalId' to define RBAC role assignments on this resource. In the roleDefinitionIdOrName attribute, you can provide either the display name of the role definition, or its fully qualified ID in the following format: '/providers/Microsoft.Authorization/roleDefinitions/c2f4ef07-c644-48eb-af81-4b1b4947fb11'."
            }
        },
        "statuses": {
            "type": "array",
            "defaultValue": [],
            "metadata": {
                "description": "Optional. Status of the connection."
            }
        },
        "tags": {
            "type": "object",
            "defaultValue": {},
            "metadata": {
                "description": "Optional. Tags of the resource."
            }
        },
        "testLinks": {
            "type": "array",
            "defaultValue": [],
            "metadata": {
                "description": "Optional. Links to test the API connection."
            }
        }
    },
    "variables": {
        "builtInRoleNames": {
            "Owner": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions','8e3af657-a8ff-443c-a75c-2fe8c4bcb635')]",
            "Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions','b24988ac-6180-42a0-ab88-20f7382dd24c')]",
            "Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions','acdd72a7-3385-48ef-bd42-f606fba81ae7')]",
            "Log Analytics Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions','92aaf0da-9dab-42b6-94a3-d43ce8d16293')]",
            "Log Analytics Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions','73c42c96-874c-492b-b04d-ab87d138a893')]",
            "Logic App Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions','87a39d53-fc1b-424a-814c-f7e04687dc9e')]",
            "Logic App Operator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions','515c2055-d9d4-4321-b1b9-bd0c9a0f79fe')]",
            "Managed Application Contributor Role": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions','641177b8-a67a-45b9-a033-47bc880bb21e')]",
            "Managed Application Operator Role": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions','c7393b34-138c-406f-901b-d8cf2b17e6ae')]",
            "Managed Applications Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions','b9331d33-8a36-4f8c-b097-4f54124fdb44')]",
            "Monitoring Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions','749f88d5-cbae-40b8-bcfc-e573ddc772fa')]",
            "Monitoring Metrics Publisher": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions','3913510d-42f4-4e42-8a64-420c390055eb')]",
            "Monitoring Reader": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions','43d0d8ad-25c7-4714-9337-8ba259a9fe05')]",
            "Resource Policy Contributor": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions','36243c78-bf99-498c-9df9-86d9f8d28608')]",
            "User Access Administrator": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions','18d7d88d-d35e-4fb5-a5c3-7773c20a72d9')]"
        }
    },
    "resources": [
        {
            "condition": "[not(empty(parameters('cuaId')))]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-01-01",
            "name": "[concat('pid-', parameters('cuaId'))]",
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "resources": []
                }
            }
        },
        // API CONNECTION DEPLOYMENT
        {
            "name": "[parameters('connectionName')]",
            "type": "Microsoft.Web/connections",
            "apiVersion": "2016-06-01",
            "location": "[parameters('location')]",
            "kind": "[parameters('connectionKind')]",
            "tags": "[parameters('tags')]",
            "properties": {
                "displayName": "[parameters('displayName')]",
                "customParameterValues": "[parameters('customParameterValues')]",
                "parameterValueType": "[if(not(empty(parameters('parameterValueType'))),parameters('parameterValueType'),json('null'))]",
                "alternativeParameterValues": "[if(not(empty(parameters('alternativeParameterValues'))),parameters('alternativeParameterValues'),json('null'))]",
                "api": "[parameters('connectionApi')]",
                "parameterValues": "[if(empty(parameters('alternativeParameterValues')), parameters('parameterValues'),json('null'))]",
                "nonSecretParameterValues": "[if(not(empty(parameters('nonSecretParameterValues'))), parameters('nonSecretParameterValues'),json('null'))]",
                "testLinks": "[if(not(empty(parameters('testLinks'))), parameters('testLinks'),json('null'))]",
                "statuses": "[if(not(empty(parameters('statuses'))), parameters('statuses'),json('null'))]"
            }
        },
        // RBAC
        {
            "name": "[concat('rbac-',deployment().name, copyIndex())]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2021-01-01",
            "condition": "[not(empty(parameters('roleAssignments')))]",
            "dependsOn": [
                "[parameters('connectionName')]"
            ],
            "copy": {
                "name": "rbacDeplCopy",
                "count": "[length(parameters('roleAssignments'))]"
            },
            "properties": {
                "mode": "Incremental",
                "expressionEvaluationOptions": {
                    "scope": "inner"
                },
                "parameters": {
                    "roleAssignment": {
                        "value": "[parameters('roleAssignments')[copyIndex()]]"
                    },
                    "builtInRoleNames": {
                        "value": "[variables('builtInRoleNames')]"
                    },
                    "connectionName": {
                        "value": "[parameters('connectionName')]"
                    }
                },
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {
                        "roleAssignment": {
                            "type": "object"
                        },
                        "builtInRoleNames": {
                            "type": "object"
                        },
                        "connectionName": {
                            "type": "string"
                        }
                    },
                    "resources": [
                        {
                            "type": "Microsoft.Web/connection/providers/roleAssignments",
                            "apiVersion": "2018-09-01-preview",
                            "name": "[concat(parameters('connectionName'), '/Microsoft.Authorization/', guid(uniqueString(concat(parameters('connectionName'), array(parameters('roleAssignment').principalIds)[copyIndex('innerRbacCopy')], parameters('roleAssignment').roleDefinitionIdOrName ) )))]",
                            "dependsOn": [
                            ],
                            "copy": {
                                "name": "innerRbacCopy",
                                "count": "[length(parameters('roleAssignment').principalIds)]"
                            },
                            "properties": {
                                "roleDefinitionId": "[if(contains(parameters('builtInRoleNames'), parameters('roleAssignment').roleDefinitionIdOrName ), parameters('builtInRoleNames')[parameters('roleAssignment').roleDefinitionIdOrName] , parameters('roleAssignment').roleDefinitionIdOrName )]",
                                "principalId": "[array(parameters('roleAssignment').principalIds)[copyIndex()]]"
                            }
                        }
                    ]
                }
            }
        }
    ],
    "functions": [],
    "outputs": {
        "connectionResourceId": {
            "type": "string",
            "value": "[resourceId('Microsoft.Web/connections',parameters('connectionName'))]",
            "metadata": {
                "description": "The Resource Id of the API Connection."
            }
        },
        "connectionResourceGroup": {
            "type": "string",
            "value": "[resourceGroup().name]",
            "metadata": {
                "description": "The name of the Resource Group the API Connection was created in."
            }
        },
        "connectionName": {
            "type": "string",
            "value": "[parameters('connectionName')]",
            "metadata": {
                "description": "The Name of the API Connection."
            }
        }
    }
}