name: '.Platform - Dependencies'

# trigger:
#   batch: true
#   branches:
#     include:
#       - main
#   paths:
#     include:
#       - '.azuredevops/pipelineTemplates/module.jobs.deploy.yml'
#       - '.azuredevops/platformPipelines/platform.dependencies.yml'
#       - 'utilities/pipelines/dependencies/**'

variables:
  - template: '/.azuredevops/pipelineVariables/global.variables.yml'
  - group: 'PLATFORM_VARIABLES'
  - name: dependencyPath
    value: 'utilities/pipelines/dependencies'
  - name: modulesPath
    value: 'arm'

stages:
  - stage: deploy_rg
    displayName: Deploy resource group
    variables:
      resourceType: 'Microsoft.Resources/resourceGroups'
      templateFilePath: $(modulesPath)/$(resourceType)/deploy.bicep
    jobs:
      - template: /.azuredevops/pipelineTemplates/module.jobs.deploy.yml
        parameters:
          deploymentBlocks:
            - path: $(dependencyPath)/$(resourceType)/parameters/artifacts.parameters.json
              templateFilePath: $(templateFilePath)
              displayName: Artifacts Resource Group
            - path: $(dependencyPath)/$(resourceType)/parameters/validation.parameters.json
              templateFilePath: $(templateFilePath)
              displayName: Validation Resource Group

  - stage: deploy_msi
    displayName: Deploy user assigned identity
    variables:
      resourceType: 'Microsoft.ManagedIdentity/userAssignedIdentities'
      templateFilePath: $(modulesPath)/$(resourceType)/deploy.bicep
    jobs:
      - template: /.azuredevops/pipelineTemplates/module.jobs.deploy.yml
        parameters:
          deploymentBlocks:
            - path: $(dependencyPath)/$(resourceType)/parameters/parameters.json
              templateFilePath: $(templateFilePath)
              displayName: User Assigned Identity
    dependsOn:
      - deploy_rg
