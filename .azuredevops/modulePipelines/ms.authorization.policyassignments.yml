name: 'Authorization - Policyassignments'

parameters:
  - name: removeDeployment
    displayName: Remove deployed module
    type: boolean
    default: false # Deployment does not support tags
  - name: versioningOption
    displayName: The mode to handle the version increments [major|minor|patch]
    type: string
    default: patch
    values:
      - patch
      - minor
      - major
  - name: customVersion
    displayName: Custom version to apply. Used only if higher than latest
    type: string
    default: '0.0.1'

trigger:
  batch: true
  branches:
    include:
      - main
  paths:
    include:
      - '/.azuredevops/modulePipelines/ms.authorization.policyassignments.yml'
      - '/.azuredevops/pipelineTemplates/module.*.yml'
      - '/arm/Microsoft.Authorization/policyAssignments/*'
    exclude:
      - '/**/*.md'

variables:
  - template: '/.azuredevops/pipelineVariables/global.variables.yml'
  - group: 'Platform-Tokens'
  - name: moduleName
    value: 'policyAssignments'
  - name: modulePath
    value: '/arm/Microsoft.Authorization/policyAssignments'

stages:
  - stage: Validation
    jobs:
      - template: /.azuredevops/pipelineTemplates/module.jobs.validate.yml
        parameters:
          deploymentBlocks: 
            - path: $(modulePath)/.parameters/allowedLocations.parameters.json
            - path: $(modulePath)/.parameters/listOfAllowedSKUs.parameters.json
            - path: $(modulePath)/.parameters/parameters.json

  - stage: Deployment
    jobs:
      - template: /.azuredevops/pipelineTemplates/module.jobs.deploy.yml
        parameters:
          removeDeployment: '${{ parameters.removeDeployment }}'
          deploymentBlocks: 
            - path: $(modulePath)/.parameters/allowedLocations.parameters.json
            - path: $(modulePath)/.parameters/listOfAllowedSKUs.parameters.json
            - path: $(modulePath)/.parameters/parameters.json

  - stage: Publishing
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - template: /.azuredevops/pipelineTemplates/module.jobs.publish.yml
        parameters:
          versioningOption: '${{ parameters.versioningOption }}'
          customVersion: '${{ parameters.customVersion }}'

  - stage: Removal
    dependsOn: Deployment
    condition: and(in(dependencies.Deployment.result, 'Succeeded', 'Failed'),  eq( '${{ parameters.removeDeployment }}', 'true'))
    jobs:
      - template: /.azuredevops/pipelineTemplates/module.jobs.remove.yml
